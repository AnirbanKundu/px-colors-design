<script>
var PxColorsBehavior = PxColorsBehavior || {};

/*
  Name:
  PxColorsBehavior.baseColors

  Description:
  Polymer behavior that provides the basic color definitions

  @polymerBehavior PxColorsBehavior.baseColors
*/
PxColorsBehavior.baseColors = {
  properties: {
    /**
     * A key/value map of Predix UI color variable names to their RGB values.
     *
     * @property colors
     * @type {Object}
     */
    colors: {
      type: Object,
      value: {
        "black"               : "rgb(0,0,0)",
        "gray20"              : "rgb(5,9,12)",
        "gray19"              : "rgb(12,20,25)",
        "gray18"              : "rgb(18,31,38)",
        "gray17"              : "rgb(27,42,51)",
        "gray16"              : "rgb(35,52,63)",
        "gray15"              : "rgb(44,64,76)",
        "gray14"              : "rgb(54,76,89)",
        "gray13"              : "rgb(66,88,102)",
        "gray12"              : "rgb(79,100,114)",
        "gray11"              : "rgb(89,113,127)",
        "gray10"              : "rgb(103,126,140)",
        "gray9"               : "rgb(116,139,153)",
        "gray8"               : "rgb(136,154,165)",
        "gray7"               : "rgb(150,168,178)",
        "gray6"               : "rgb(163,181,191)",
        "gray5"               : "rgb(182,195,204)",
        "gray4"               : "rgb(197,209,216)",
        "gray3"               : "rgb(216,224,229)",
        "gray2"               : "rgb(226,232,237)",
        "gray1"               : "rgb(235,239,242)",
        "white"               : "rgb(255,255,255)",
        "primary-default"     : "rgb(0,122,204)",
        "primary-hover"       : "rgb(0,92,153)",
        "primary-pressed"     : "rgb(0,61,102)",
        "primary-light"       : "rgb(238,251,255)",
        "select-default"      : "rgb(9,129,156)",
        "select-hover"        : "rgb(6,87,105)",
        "select-pressed"      : "rgb(3,44,54)",
        "select-light"        : "rgb(230,251,255)",
        "d-actionable-default": "rgb(69,172,229)",
        "d-actionable-hover"  : "rgb(45,115,153)",
        "d-actionable-pressed": "rgb(30,77,102)",
        "status-red1"         : "rgb(255,236,236)",
        "status-red2"         : "rgb(249,165,159)",
        "status-red3"         : "rgb(243,67,54)",
        "status-red4"         : "rgb(180,0,0)",
        "status-orange1"      : "rgb(255,240,230)",
        "status-orange2"      : "rgb(255,196,153)",
        "status-orange3"      : "rgb(255,139,58)",
        "status-orange4"      : "rgb(204,85,0)",
        "status-yellow1"      : "rgb(255,246,217)",
        "status-yellow2"      : "rgb(255,224,112)",
        "status-yellow3"      : "rgb(254,198,0)",
        "status-yellow4"      : "rgb(163,128,1)",
        "status-blue1"        : "rgb(230,245,255)",
        "status-blue2"        : "rgb(88,171,238)",
        "status-blue3"        : "rgb(20,121,201)",
        "status-blue4"        : "rgb(12,66,111)",
        "status-green1"       : "rgb(236,255,238)",
        "status-green2"       : "rgb(180,227,79)",
        "status-green3"       : "rgb(127,174,27)",
        "status-green4"       : "rgb(66,88,14)",
      }
    }
  }
};

/*
  Name:
  PxColorsBehavior.dataVisColors

  Description:
  Polymer behavior that provides the dataVisColors and an order to use them

  @polymerBehavior PxColorsBehavior.dataVisColors
*/
PxColorsBehavior.dataVisColors = {
  properties: {
    /**
     * Defines an colors in order that will be used for series.
     *
     * @type {Array}
     */
    seriesColorList: {
      type: Array,
      value: [
        'rgb(0,0,0)',
        'rgb(75,75,75)',
        'rgb(125,125,125)',
        'rgb(200,200,200)'
      ]
    }
  }
};

/*
  Name:
  PxColorsBehavior.commonColors

  Description:
  Polymer behavior that provides the basic color definitions. Colors match (and are generated from) px-colors-design SCSS.
  This allows access to the color definitions in javascript for applications where CSS is not ideal.


  @polymerBehavior PxColorsBehavior.commonColors
*/
PxColorsBehavior.commonColors = [PxColorsBehavior.dataVisColors, PxColorsBehavior.baseColors];


/*
  Name:
  PxColorsBehavior.dataVisColorTheming

  Description:
  Attempts to read data vis color theme from CSS style variables or default
  values and apply to the visualization element.

  @polymerBehavior PxColorsBehavior.dataVisColorTheming
*/
PxColorsBehavior.dataVisColorTheming = [{
    ready: function() {
      // To access any available CSS theming variables, we need to wait for the
      // first animation frame to complete
      window.requestAnimationFrame(this.syncCSSTheme.bind(this));
    },

    /**
     * Retrieves the CSS style variables set on this element and applies them
     * to the appropriate properties, triggering a redraw.
     *
     * @method syncCSSTheme
     */
    syncCSSTheme: function() {
      // FIXME Aggressive debounce for simple charts. Look in solving the issue so we can reduce/remove this debounce.
      this.debounce('syncCSSTheme', this._debounceSyncCSSTheme, 100);
    },

    /**
     * Debounced function call for `syncCSSTheme` method. Loops through available
     * style variables to apply them to appropriate objects.
     *
     * @private
     * @method _debounceSyncCSSTheme
     */
    _debounceSyncCSSTheme: function() {
      var firstThemedColor = this.getComputedStyleValue('--px-vis-series-color-0');

      // If there's a theme color set, attempt to get all CSS style variables
      // and prepare to apply them.
      if (firstThemedColor) {
        this._applyStyleVariables();
      }
      // Otherwise, apply our default colors
      // REDESIGN: Might need to change this so it checks if default was overwritten and use it instead of theme
      // else {
      //   this._applyDefaultStyleVariables();
      // };

      this.dispatchEvent(new CustomEvent('px-data-vis-colors-applied'));
    },

    /**
     * Called when there is at least one style variable applied (the first is
     * expected to be named `--px-vis-series-color-0`). Loops through each
     * style variable in the format `--px-vis-series-color-[n]` and applies
     * the resulting values and series color order to the element. Stops looping
     * through style variables when it finds a gap.
     *
     * @private
     * @method _applyStyleVariables
     */
    _applyStyleVariables: function() {
      var variableBase = '--px-vis-series-color-';
      var newColors = [];
      var index = 0;
      var stop = false;
      var currentColor;

      //check if the developer passed in their own seriesColorOrder
      var devSet = this._checkIfDevSetSeriesColorOrder();
      if(devSet) {
        return;
      }

      // Loop over style variables until a gap is found
      while (!stop) {
        currentColor = this.getComputedStyleValue('--px-vis-series-color-' + index);

        if (!currentColor) {
          // No more colors found, break out of while loop
          stop = true;
        };

        if (currentColor) {
          // Ensure the color is converted to RGB
          currentColor = currentColor[0] === '#' ? this._colorHexToRgb(currentColor) : currentColor;

          newColors.push(currentColor);
        };

        // Iterate index so we continue to get style variables
        index += 1;
      };

      this.set('seriesColorList', newColors);
    },

    /**
     * Called when there are no style variables applied. Collects the default
     * data vis colors and sets the `dataVisColors` and `seriesColorOrder`
     * properties.
     *
     * @private
     * @method _applyDefaultStyleVariables
     */
    // _applyDefaultStyleVariables: function() {
    //   var newColors = {};
    //   var newOrder = [];
    //   var dataVisColorsKeys = Object.keys(this.dataVisColors);
    //   var i;
    //   var length;

    //   //check if the developer passed in their own seriesColorOrder
    //   var devSet = this._checkIfDevSetSeriesColorOrder();

    //   for (i = 0, length = dataVisColorsKeys.length; i < length; i++) {
    //     newColors[dataVisColorsKeys[i]] = this.dataVisColors[dataVisColorsKeys[i]];
    //     newColors['pxVisSeriesColor' + i] = this.dataVisColors[dataVisColorsKeys[i]];
    //   };

    //   if(!devSet) {
    //     var updatedDataVisColorsKeys = Object.keys(newColors);
    //     for (i = 0, length = this.seriesColorOrder.length; i < length; i++) {
    //       var visIndex = dataVisColorsKeys.indexOf(this.seriesColorOrder[i]);
    //       newOrder[i] = 'pxVisSeriesColor' + visIndex;
    //     };

    //     // Set properties on self to new values
    //     // @TODO Use batch update in Polymer 2.0
    //     this.set('seriesColorOrder', newOrder);
    //   }

    //   this.set('dataVisColors', newColors);
    // },

    /**
     * Converts a hex-format color to RGB.
     *
     * @private
     * @method _colorHexToRgb
     * @param {String} hex - A color in hex format
     * @return {String} - A color in RGB format
     */
    _colorHexToRgb: function(hex) {
      // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
      var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
      hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
      });
      var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? 'rgb(' + parseInt(result[1], 16) + ',' +
                               parseInt(result[2], 16)+ ',' +
                               parseInt(result[3], 16) + ')' : null;
    },

    /**
     * Compares seriesColorOrder property value to the seriesColorOrder to determine if the dev set their own override.
     *
     * @private
     * @method _checkIfDevSetSeriesColorOrder
     * @return {Boolean} - true if dev set seriesColorOrder
     */
    _checkIfDevSetSeriesColorOrder: function() {
      var defaultOrder = PxColorsBehavior.dataVisColors.properties.seriesColorList.value;

      if(defaultOrder.length !== this.seriesColorList.length) {
        return true;
      }

      for(var i = 0; i < defaultOrder.length; i++) {
        if(defaultOrder[i] !== this.seriesColorList[i]) {
          return true;
        }
      }

      return false;
    }

}, PxColorsBehavior.dataVisColors];
</script>
